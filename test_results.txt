============================= test session starts ==============================
platform darwin -- Python 3.13.5, pytest-8.3.4, pluggy-1.5.0 -- /opt/anaconda3/bin/python
cachedir: .pytest_cache
rootdir: /Users/dongshulin/Library/CloudStorage/OneDrive-2ai.cx/Desktop/GitHub/multi_Agent_Conversation_System
plugins: opik-1.8.34, langsmith-0.4.17, asyncio-1.2.0, anyio-4.12.0, cov-7.0.0
asyncio: mode=Mode.STRICT, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collecting ... collected 41 items

tests/integration/test_agent_coordination.py::TestMultiAgentWorkflow::test_complete_workflow_success FAILED [  2%]
tests/integration/test_agent_coordination.py::TestMultiAgentWorkflow::test_workflow_with_refinement FAILED [  4%]
tests/integration/test_agent_coordination.py::TestMultiAgentWorkflow::test_workflow_with_graceful_failure FAILED [  7%]
tests/integration/test_agent_coordination.py::TestMultiAgentWorkflow::test_workflow_performance FAILED [  9%]
tests/test_json_minification_integration.py::test_basic_minification PASSED [ 12%]
tests/test_json_minification_integration.py::test_round_trip PASSED      [ 14%]
tests/test_json_minification_integration.py::test_token_savings PASSED   [ 17%]
tests/test_json_minification_integration.py::test_minification_instruction PASSED [ 19%]
tests/test_json_minification_integration.py::test_json_extraction PASSED [ 21%]
tests/test_json_minification_integration.py::test_no_abbreviation PASSED [ 24%]
tests/test_json_minification_integration.py::test_large_dataset PASSED   [ 26%]
tests/unit/test_branding.py::TestBrandingFormatSMS::test_format_sms_removes_markdown FAILED [ 29%]
tests/unit/test_branding.py::TestBrandingFormatSMS::test_format_sms_respects_length_limit FAILED [ 31%]
tests/unit/test_branding.py::TestBrandingFormatSMS::test_format_sms_plain_text_only FAILED [ 34%]
tests/unit/test_branding.py::TestBrandingFormatSMS::test_format_sms_splits_at_sentence_boundaries FAILED [ 36%]
tests/unit/test_branding.py::TestBrandingFormatEmail::test_format_email_supports_markdown FAILED [ 39%]
tests/unit/test_branding.py::TestBrandingFormatEmail::test_format_email_no_length_limit FAILED [ 41%]
tests/unit/test_branding.py::TestBrandingStyleGuide::test_applies_emojis_when_enabled FAILED [ 43%]
tests/unit/test_branding.py::TestBrandingStyleGuide::test_applies_user_name_when_configured FAILED [ 46%]
tests/unit/test_planner.py::TestPlannerAnalyzeRequest::test_analyze_request_creates_execution_plan FAILED [ 48%]
tests/unit/test_planner.py::TestPlannerAnalyzeRequest::test_analyze_request_creates_scorecard FAILED [ 51%]
tests/unit/test_planner.py::TestPlannerAnalyzeRequest::test_analyze_request_handles_sms_channel FAILED [ 53%]
tests/unit/test_planner.py::TestPlannerComposeResponse::test_compose_response_with_timesheet_data PASSED [ 56%]
tests/unit/test_planner.py::TestPlannerComposeResponse::test_compose_response_without_timesheet_data PASSED [ 58%]
tests/unit/test_planner.py::TestPlannerRefineResponse::test_refine_response_improves_quality PASSED [ 60%]
tests/unit/test_planner.py::TestPlannerRefineResponse::test_refine_response_max_one_attempt PASSED [ 63%]
tests/unit/test_planner.py::TestPlannerGracefulFailure::test_compose_graceful_failure_user_friendly PASSED [ 65%]
tests/unit/test_quality.py::TestQualityValidateResponse::test_validate_passing_response PASSED [ 68%]
tests/unit/test_quality.py::TestQualityValidateResponse::test_validate_failing_response PASSED [ 70%]
tests/unit/test_quality.py::TestQualityValidateResponse::test_validate_evaluates_all_criteria PASSED [ 73%]
tests/unit/test_quality.py::TestQualityValidateResponse::test_validate_provides_specific_feedback PASSED [ 75%]
tests/unit/test_quality.py::TestQualityValidateResponse::test_validate_aggregates_multiple_failures PASSED [ 78%]
tests/unit/test_quality.py::TestQualityValidateGracefulFailure::test_validate_graceful_failure_always_approves PASSED [ 80%]
tests/unit/test_quality.py::TestQualityValidateGracefulFailure::test_validate_graceful_failure_logs_details PASSED [ 82%]
tests/unit/test_quality.py::TestQualityPerformance::test_validation_completes_within_time_limit FAILED [ 85%]
tests/unit/test_timesheet.py::TestTimesheetExtractData::test_extract_hours_logged PASSED [ 87%]
tests/unit/test_timesheet.py::TestTimesheetExtractData::test_extract_projects PASSED [ 90%]
tests/unit/test_timesheet.py::TestTimesheetExtractData::test_extract_handles_api_error PASSED [ 92%]
tests/unit/test_timesheet.py::TestTimesheetExtractData::test_extract_uses_user_credentials PASSED [ 95%]
tests/unit/test_timesheet.py::TestTimesheetExtractData::test_extract_respects_timezone PASSED [ 97%]
tests/unit/test_timesheet.py::TestTimesheetExtractData::test_extract_multiple_query_types PASSED [100%]

=================================== FAILURES ===================================
____________ TestMultiAgentWorkflow.test_complete_workflow_success _____________
tests/integration/test_agent_coordination.py:82: in test_complete_workflow_success
    plan = ExecutionPlan(**plan_result["execution_plan"])
E   pydantic_core._pydantic_core.ValidationError: 1 validation error for ExecutionPlan
E   steps
E     Field required [type=missing, input_value={'request_id': 'integrati...': <Channel.SMS: 'sms'>}, input_type=dict]
E       For further information visit https://errors.pydantic.dev/2.12/v/missing
------------------------------ Captured log call -------------------------------
WARNING  agents.base:planner.py:295 ‚ö†Ô∏è [Planner] JSON parse error: Expecting value: line 1 column 1 (char 0). Using minimal fallback.
_____________ TestMultiAgentWorkflow.test_workflow_with_refinement _____________
tests/integration/test_agent_coordination.py:208: in test_workflow_with_refinement
    validation1["validation_result"]["failed_criteria"],
E   KeyError: 'failed_criteria'
------------------------------ Captured log call -------------------------------
WARNING  agents.base:planner.py:295 ‚ö†Ô∏è [Planner] JSON parse error: Expecting value: line 1 column 1 (char 0). Using minimal fallback.
WARNING  agents.base:branding.py:127 ‚ö†Ô∏è [Branding] Could not parse LLM response, using original
WARNING  agents.base:quality.py:64   ‚ùå FAIL: answers_question - default
WARNING  agents.base:quality.py:74 ‚ùå [Quality] 1 criteria failed: answers_question
WARNING  agents.base:quality.py:207 Validation failure: {"request_id":"integration-test-002","original_question":"Check my timesheet","scorecard":{"request_id":"integration-test-002","criteria":[{"id":"answers_question","description":"Response answers user's question","expected":"Response addresses the user's query","passed":false,"feedback":"default"}],"overall_passed":false,"created_at":"2025-12-02T00:23:10.047806","evaluated_at":"2025-12-02T00:23:10.048055"},"validation_results":[{"id":"answers_question","description":"Response answers user's question","expected":"Response addresses the user's query","passed":false,"feedback":"default"}],"refinement_attempted":false,"refinement_succeeded":null,"final_outcome":"Pending refinement","failure_reason":"1 criteria failed validation","logged_at":"2025-12-02T00:23:10.048081"}
__________ TestMultiAgentWorkflow.test_workflow_with_graceful_failure __________
tests/integration/test_agent_coordination.py:258: in test_workflow_with_graceful_failure
    plan_result = await all_agents["planner"].analyze_request(
agents/planner.py:255: in analyze_request
    self.logger.info(f"üîç [Planner] RAW LLM response: {llm_response[:500]}")
E   KeyError: slice(None, 500, None)
_______________ TestMultiAgentWorkflow.test_workflow_performance _______________
tests/integration/test_agent_coordination.py:320: in test_workflow_performance
    await all_agents["planner"].analyze_request(
agents/planner.py:255: in analyze_request
    self.logger.info(f"üîç [Planner] RAW LLM response: {llm_response[:500]}")
E   KeyError: slice(None, 500, None)
____________ TestBrandingFormatSMS.test_format_sms_removes_markdown ____________
tests/unit/test_branding.py:30: in test_format_sms_removes_markdown
    result = await branding_agent.format_for_channel(
agents/branding.py:118: in format_for_channel
    result = json.loads(llm_response)
/opt/anaconda3/lib/python3.13/json/__init__.py:339: in loads
    raise TypeError(f'the JSON object must be str, bytes or bytearray, '
E   TypeError: the JSON object must be str, bytes or bytearray, not AsyncMock
_________ TestBrandingFormatSMS.test_format_sms_respects_length_limit __________
tests/unit/test_branding.py:50: in test_format_sms_respects_length_limit
    result = await branding_agent.format_for_channel(
agents/branding.py:118: in format_for_channel
    result = json.loads(llm_response)
/opt/anaconda3/lib/python3.13/json/__init__.py:339: in loads
    raise TypeError(f'the JSON object must be str, bytes or bytearray, '
E   TypeError: the JSON object must be str, bytes or bytearray, not AsyncMock
____________ TestBrandingFormatSMS.test_format_sms_plain_text_only _____________
tests/unit/test_branding.py:74: in test_format_sms_plain_text_only
    result = await branding_agent.format_for_channel(
agents/branding.py:118: in format_for_channel
    result = json.loads(llm_response)
/opt/anaconda3/lib/python3.13/json/__init__.py:339: in loads
    raise TypeError(f'the JSON object must be str, bytes or bytearray, '
E   TypeError: the JSON object must be str, bytes or bytearray, not AsyncMock
_____ TestBrandingFormatSMS.test_format_sms_splits_at_sentence_boundaries ______
tests/unit/test_branding.py:97: in test_format_sms_splits_at_sentence_boundaries
    result = await branding_agent.format_for_channel(
agents/branding.py:118: in format_for_channel
    result = json.loads(llm_response)
/opt/anaconda3/lib/python3.13/json/__init__.py:339: in loads
    raise TypeError(f'the JSON object must be str, bytes or bytearray, '
E   TypeError: the JSON object must be str, bytes or bytearray, not AsyncMock
_________ TestBrandingFormatEmail.test_format_email_supports_markdown __________
tests/unit/test_branding.py:134: in test_format_email_supports_markdown
    result = await branding_agent.format_for_channel(
agents/branding.py:118: in format_for_channel
    result = json.loads(llm_response)
/opt/anaconda3/lib/python3.13/json/__init__.py:339: in loads
    raise TypeError(f'the JSON object must be str, bytes or bytearray, '
E   TypeError: the JSON object must be str, bytes or bytearray, not AsyncMock
__________ TestBrandingFormatEmail.test_format_email_no_length_limit ___________
tests/unit/test_branding.py:155: in test_format_email_no_length_limit
    result = await branding_agent.format_for_channel(
agents/branding.py:118: in format_for_channel
    result = json.loads(llm_response)
/opt/anaconda3/lib/python3.13/json/__init__.py:339: in loads
    raise TypeError(f'the JSON object must be str, bytes or bytearray, '
E   TypeError: the JSON object must be str, bytes or bytearray, not AsyncMock
___________ TestBrandingStyleGuide.test_applies_emojis_when_enabled ____________
tests/unit/test_branding.py:189: in test_applies_emojis_when_enabled
    result = await branding_agent.format_for_channel(
agents/branding.py:118: in format_for_channel
    result = json.loads(llm_response)
/opt/anaconda3/lib/python3.13/json/__init__.py:339: in loads
    raise TypeError(f'the JSON object must be str, bytes or bytearray, '
E   TypeError: the JSON object must be str, bytes or bytearray, not AsyncMock
________ TestBrandingStyleGuide.test_applies_user_name_when_configured _________
tests/unit/test_branding.py:215: in test_applies_user_name_when_configured
    result = await branding_agent.format_for_channel(
agents/branding.py:118: in format_for_channel
    result = json.loads(llm_response)
/opt/anaconda3/lib/python3.13/json/__init__.py:339: in loads
    raise TypeError(f'the JSON object must be str, bytes or bytearray, '
E   TypeError: the JSON object must be str, bytes or bytearray, not AsyncMock
____ TestPlannerAnalyzeRequest.test_analyze_request_creates_execution_plan _____
tests/unit/test_planner.py:45: in test_analyze_request_creates_execution_plan
    result = await planner_agent.analyze_request(
agents/planner.py:255: in analyze_request
    self.logger.info(f"üîç [Planner] RAW LLM response: {llm_response[:500]}")
E   KeyError: slice(None, 500, None)
_______ TestPlannerAnalyzeRequest.test_analyze_request_creates_scorecard _______
tests/unit/test_planner.py:79: in test_analyze_request_creates_scorecard
    result = await planner_agent.analyze_request(
agents/planner.py:255: in analyze_request
    self.logger.info(f"üîç [Planner] RAW LLM response: {llm_response[:500]}")
E   KeyError: slice(None, 500, None)
______ TestPlannerAnalyzeRequest.test_analyze_request_handles_sms_channel ______
tests/unit/test_planner.py:105: in test_analyze_request_handles_sms_channel
    result = await planner_agent.analyze_request(
agents/planner.py:255: in analyze_request
    self.logger.info(f"üîç [Planner] RAW LLM response: {llm_response[:500]}")
E   KeyError: slice(None, 500, None)
______ TestQualityPerformance.test_validation_completes_within_time_limit ______
tests/unit/test_quality.py:258: in test_validation_completes_within_time_limit
    ScorecardCriterion(id="c1", description="Test", expected="Pass")
E   pydantic_core._pydantic_core.ValidationError: 1 validation error for ScorecardCriterion
E   description
E     Value error, Criterion description must be specific (min 10 chars) [type=value_error, input_value='Test', input_type=str]
E       For further information visit https://errors.pydantic.dev/2.12/v/value_error
=============================== warnings summary ===============================
agents/models.py:78
  /Users/dongshulin/Library/CloudStorage/OneDrive-2ai.cx/Desktop/GitHub/multi_Agent_Conversation_System/agents/models.py:78: PydanticDeprecatedSince20: Pydantic V1 style `@validator` validators are deprecated. You should migrate to Pydantic V2 style `@field_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    @validator('steps')

agents/models.py:97
  /Users/dongshulin/Library/CloudStorage/OneDrive-2ai.cx/Desktop/GitHub/multi_Agent_Conversation_System/agents/models.py:97: PydanticDeprecatedSince20: Pydantic V1 style `@validator` validators are deprecated. You should migrate to Pydantic V2 style `@field_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    @validator('description')

agents/models.py:107
  /Users/dongshulin/Library/CloudStorage/OneDrive-2ai.cx/Desktop/GitHub/multi_Agent_Conversation_System/agents/models.py:107: PydanticDeprecatedSince20: `min_items` is deprecated and will be removed, use `min_length` instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    criteria: List[ScorecardCriterion] = Field(..., min_items=1)

agents/models.py:134
  /Users/dongshulin/Library/CloudStorage/OneDrive-2ai.cx/Desktop/GitHub/multi_Agent_Conversation_System/agents/models.py:134: PydanticDeprecatedSince20: Pydantic V1 style `@validator` validators are deprecated. You should migrate to Pydantic V2 style `@field_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    @validator('feedback')

agents/models.py:145
  /Users/dongshulin/Library/CloudStorage/OneDrive-2ai.cx/Desktop/GitHub/multi_Agent_Conversation_System/agents/models.py:145: PydanticDeprecatedSince20: `min_items` is deprecated and will be removed, use `min_length` instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    failed_criteria: List[ScorecardCriterion] = Field(..., min_items=1)

agents/models.py:149
  /Users/dongshulin/Library/CloudStorage/OneDrive-2ai.cx/Desktop/GitHub/multi_Agent_Conversation_System/agents/models.py:149: PydanticDeprecatedSince20: Pydantic V1 style `@validator` validators are deprecated. You should migrate to Pydantic V2 style `@field_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    @validator('attempt_number')

agents/models.py:177
  /Users/dongshulin/Library/CloudStorage/OneDrive-2ai.cx/Desktop/GitHub/multi_Agent_Conversation_System/agents/models.py:177: PydanticDeprecatedSince20: Pydantic V1 style `@validator` validators are deprecated. You should migrate to Pydantic V2 style `@field_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    @validator('content')

agents/models.py:184
  /Users/dongshulin/Library/CloudStorage/OneDrive-2ai.cx/Desktop/GitHub/multi_Agent_Conversation_System/agents/models.py:184: PydanticDeprecatedSince20: Pydantic V1 style `@validator` validators are deprecated. You should migrate to Pydantic V2 style `@field_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    @validator('parts')

agents/models.py:207
  /Users/dongshulin/Library/CloudStorage/OneDrive-2ai.cx/Desktop/GitHub/multi_Agent_Conversation_System/agents/models.py:207: PydanticDeprecatedSince20: Pydantic V1 style `@validator` validators are deprecated. You should migrate to Pydantic V2 style `@field_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    @validator('error')

agents/models.py:226
  /Users/dongshulin/Library/CloudStorage/OneDrive-2ai.cx/Desktop/GitHub/multi_Agent_Conversation_System/agents/models.py:226: PydanticDeprecatedSince20: Pydantic V1 style `@validator` validators are deprecated. You should migrate to Pydantic V2 style `@field_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    @validator('refinement_succeeded')

agents/models.py:307
  /Users/dongshulin/Library/CloudStorage/OneDrive-2ai.cx/Desktop/GitHub/multi_Agent_Conversation_System/agents/models.py:307: PydanticDeprecatedSince20: Pydantic V1 style `@validator` validators are deprecated. You should migrate to Pydantic V2 style `@field_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    @validator('refinement_count')

llm/config.py:13
  /Users/dongshulin/Library/CloudStorage/OneDrive-2ai.cx/Desktop/GitHub/multi_Agent_Conversation_System/llm/config.py:13: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class LLMConfig(BaseSettings):

../../../../../../../../opt/anaconda3/lib/python3.13/site-packages/pydantic/main.py:250: 6 warnings
tests/integration/test_agent_coordination.py: 6 warnings
tests/unit/test_quality.py: 11 warnings
  /opt/anaconda3/lib/python3.13/site-packages/pydantic/main.py:250: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    validated_self = self.__pydantic_validator__.validate_python(data, self_instance=self)

tests/integration/test_agent_coordination.py::TestMultiAgentWorkflow::test_workflow_with_refinement
tests/unit/test_quality.py::TestQualityValidateResponse::test_validate_passing_response
tests/unit/test_quality.py::TestQualityValidateResponse::test_validate_failing_response
tests/unit/test_quality.py::TestQualityValidateResponse::test_validate_evaluates_all_criteria
tests/unit/test_quality.py::TestQualityValidateResponse::test_validate_provides_specific_feedback
tests/unit/test_quality.py::TestQualityValidateResponse::test_validate_aggregates_multiple_failures
  /Users/dongshulin/Library/CloudStorage/OneDrive-2ai.cx/Desktop/GitHub/multi_Agent_Conversation_System/agents/models.py:117: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    self.evaluated_at = datetime.utcnow()

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ============================
FAILED tests/integration/test_agent_coordination.py::TestMultiAgentWorkflow::test_complete_workflow_success
FAILED tests/integration/test_agent_coordination.py::TestMultiAgentWorkflow::test_workflow_with_refinement
FAILED tests/integration/test_agent_coordination.py::TestMultiAgentWorkflow::test_workflow_with_graceful_failure
FAILED tests/integration/test_agent_coordination.py::TestMultiAgentWorkflow::test_workflow_performance
FAILED tests/unit/test_branding.py::TestBrandingFormatSMS::test_format_sms_removes_markdown
FAILED tests/unit/test_branding.py::TestBrandingFormatSMS::test_format_sms_respects_length_limit
FAILED tests/unit/test_branding.py::TestBrandingFormatSMS::test_format_sms_plain_text_only
FAILED tests/unit/test_branding.py::TestBrandingFormatSMS::test_format_sms_splits_at_sentence_boundaries
FAILED tests/unit/test_branding.py::TestBrandingFormatEmail::test_format_email_supports_markdown
FAILED tests/unit/test_branding.py::TestBrandingFormatEmail::test_format_email_no_length_limit
FAILED tests/unit/test_branding.py::TestBrandingStyleGuide::test_applies_emojis_when_enabled
FAILED tests/unit/test_branding.py::TestBrandingStyleGuide::test_applies_user_name_when_configured
FAILED tests/unit/test_planner.py::TestPlannerAnalyzeRequest::test_analyze_request_creates_execution_plan
FAILED tests/unit/test_planner.py::TestPlannerAnalyzeRequest::test_analyze_request_creates_scorecard
FAILED tests/unit/test_planner.py::TestPlannerAnalyzeRequest::test_analyze_request_handles_sms_channel
FAILED tests/unit/test_quality.py::TestQualityPerformance::test_validation_completes_within_time_limit
================== 16 failed, 25 passed, 41 warnings in 0.29s ==================
